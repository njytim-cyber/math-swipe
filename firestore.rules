rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Users Collection ──
    match /users/{uid} {
      // Any authenticated user can read (needed for leaderboard)
      allow read: if request.auth != null;

      // Users can only write their OWN document
      // Field validation: prevent injecting arbitrary large payloads
      allow write: if request.auth != null
                   && request.auth.uid == uid
                   && request.resource.data.keys().hasOnly([
                        'displayName', 'totalXP', 'bestStreak', 'totalSolved',
                        'accuracy', 'isAnonymous', 'createdAt', 'updatedAt',
                        'stats', 'achievements', 'preferences',
                        'activeThemeId', 'activeCostume', 'activeTrailId'
                      ])
                   // Enforce displayName length and type
                   && (!('displayName' in request.resource.data)
                       || (request.resource.data.displayName is string
                           && request.resource.data.displayName.size() <= 20));
    }

    // ── Pings Collection (social nudges) ──
    match /pings/{pingId} {
      // Users can only read pings targeted at them
      allow read: if request.auth != null
                  && resource.data.targetUid == request.auth.uid;

      // Authenticated users can create pings (but not update/delete)
      allow create: if request.auth != null
                    && request.resource.data.keys().hasOnly([
                         'targetUid', 'senderUid', 'senderName',
                         'createdAt', 'read'
                       ])
                    && request.resource.data.senderUid == request.auth.uid
                    && request.resource.data.senderName is string
                    && request.resource.data.senderName.size() <= 20
                    && request.resource.data.targetUid is string
                    && request.resource.data.read == false;

      // Only the target user can mark a ping as read
      allow update: if request.auth != null
                    && resource.data.targetUid == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
    }
  }
}
