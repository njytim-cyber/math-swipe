rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Users Collection ──
    match /users/{uid} {
      // Any authenticated user can read (needed for leaderboard)
      allow read: if request.auth != null;

      // Users can only write their OWN document
      // Field validation: prevent injecting arbitrary large payloads
      allow write: if request.auth != null
                   && request.auth.uid == uid
                   && request.resource.data.keys().hasOnly([
                        'displayName', 'totalXP', 'bestStreak', 'totalSolved',
                        'accuracy', 'isAnonymous', 'createdAt', 'updatedAt',
                        'stats', 'achievements', 'preferences',
                        'activeThemeId', 'activeCostume', 'activeTrailId', 'activeBadgeId',
                        'bestSpeedrunTime', 'speedrunHardMode', 'totalCorrect', 'sessionsPlayed',
                        'dayStreak', 'streakShields', 'lastPlayedDate', 'byType',
                        'hardModeSolved', 'hardModeCorrect', 'hardModeBestStreak', 'hardModeSessions', 'hardModePerfects',
                        'timedModeSolved', 'timedModeCorrect', 'timedModeBestStreak', 'timedModeSessions', 'timedModePerfects',
                        'ultimateSolved', 'ultimateCorrect', 'ultimateBestStreak', 'ultimateSessions', 'ultimatePerfects'
                      ])
                   // String field constraints
                   && (!('displayName' in request.resource.data)
                       || (request.resource.data.displayName is string
                           && request.resource.data.displayName.size() <= 20))
                   && (!('activeBadgeId' in request.resource.data)
                       || (request.resource.data.activeBadgeId is string
                           && request.resource.data.activeBadgeId.size() <= 50))
                   && (!('activeThemeId' in request.resource.data)
                       || (request.resource.data.activeThemeId is string
                           && request.resource.data.activeThemeId.size() <= 50))
                   && (!('activeCostume' in request.resource.data)
                       || (request.resource.data.activeCostume is string
                           && request.resource.data.activeCostume.size() <= 50))
                   && (!('activeTrailId' in request.resource.data)
                       || (request.resource.data.activeTrailId is string
                           && request.resource.data.activeTrailId.size() <= 50))
                   // Numeric field constraints
                   && (!('bestSpeedrunTime' in request.resource.data)
                       || (request.resource.data.bestSpeedrunTime is number
                           && request.resource.data.bestSpeedrunTime >= 0))
                   && (!('totalXP' in request.resource.data)
                       || (request.resource.data.totalXP is number
                           && request.resource.data.totalXP >= 0))
                   && (!('streakShields' in request.resource.data)
                       || (request.resource.data.streakShields is number
                           && request.resource.data.streakShields >= 0
                           && request.resource.data.streakShields <= 10));
    }

    // ── Pings Collection (social nudges) ──
    match /pings/{pingId} {
      // Users can only read pings targeted at them
      allow read: if request.auth != null
                  && resource.data.targetUid == request.auth.uid;

      // Authenticated users can create pings (but not update/delete)
      allow create: if request.auth != null
                    && request.resource.data.keys().hasOnly([
                         'targetUid', 'senderUid', 'senderName',
                         'createdAt', 'read'
                       ])
                    && request.resource.data.senderUid == request.auth.uid
                    && request.resource.data.senderName is string
                    && request.resource.data.senderName.size() <= 20
                    && request.resource.data.targetUid is string
                    && request.resource.data.read == false;

      // Only the target user can mark a ping as read
      allow update: if request.auth != null
                    && resource.data.targetUid == request.auth.uid
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
    }

    // ── Error Reports (monitoring) ──
    match /errors/{errorId} {
      // No reads — only admins via console
      allow read: if false;

      // Authenticated users can create error reports
      allow create: if request.auth != null
                    && request.resource.data.keys().hasOnly([
                         'message', 'stack', 'source', 'userAgent', 'url', 'timestamp'
                       ])
                    && request.resource.data.message is string
                    && request.resource.data.message.size() <= 500;

      allow update, delete: if false;
    }
  }
}
